<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        :root {
            --bg-cream: #fcf8f1;
            --card-warm: #fffdfa;
            --border-warm: #f3e9d9;
            --accent-orange: #f59e0b;
        }

        body {
            font-family: 'Noto+Sans+JP', sans-serif;
            background-color: var(--bg-cream);
            overscroll-behavior-y: none;
        }

        .app-container {
            max-width: 448px; 
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--bg-cream);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .tab-active {
            color: var(--accent-orange);
        }

        .sticky-note {
            background-color: #fef3c7;
            box-shadow: 2px 3px 8px rgba(180, 83, 9, 0.08);
            transition: all 0.3s ease;
            width: 100%;
        }

        .sticky-note.read {
            background-color: #f3efea;
            opacity: 0.6;
            box-shadow: none;
        }

        .card-warm {
            background-color: var(--card-warm);
            border: 1px solid var(--border-warm);
        }

        .stock-card {
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 0.5rem;
        }

        .status-circle-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 36px;
            height: 36px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.12);
        }

        .bottom-nav {
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        main {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 90px;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
    </style>
</head>
<body>

    <div class="app-container border-x border-gray-100 shadow-xl">
        <!-- Header -->
        <header class="bg-[#fefaf3]/90 backdrop-blur-md sticky top-0 z-20 border-b border-[#f3e9d9] px-4 py-3 flex justify-between items-center">
            <div class="flex flex-col">
                <h1 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="home" class="w-5 h-5 text-orange-500"></i>
                    Family Dash
                </h1>
                <div class="flex items-center gap-1">
                    <span id="sync-status" class="sync-indicator bg-gray-300"></span>
                    <span id="sync-text" class="text-[9px] text-gray-400 font-bold uppercase tracking-wider">Connecting...</span>
                </div>
            </div>
            <div id="current-time" class="text-xs text-amber-800/60 font-bold"></div>
        </header>

        <main class="p-3 space-y-4">
            <!-- Kitchen Stock Section -->
            <section id="content-stock" class="space-y-3">
                <div class="card-warm p-3 rounded-2xl shadow-sm">
                    <div class="flex gap-2">
                        <input type="text" id="stock-name" placeholder="品名を追加 (例: 卵)" class="flex-1 border border-orange-100 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-200">
                        <button onclick="addStock()" class="bg-orange-500 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-md active:scale-95 transition-transform">
                            追加
                        </button>
                    </div>
                </div>
                <div id="stock-list" class="grid grid-cols-3 gap-2"></div>
            </section>

            <!-- Memo Section -->
            <section id="content-memo" class="hidden space-y-4">
                <div class="card-warm p-4 rounded-2xl shadow-sm">
                    <h2 class="font-bold mb-3 flex items-center gap-2 text-gray-700 text-sm">
                        <i data-lucide="pen-tool" class="w-4 h-4 text-amber-500"></i>
                        新しいメモ
                    </h2>
                    <textarea id="memo-text" rows="3" placeholder="伝言などを入力..." class="w-full border border-orange-100 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-amber-200"></textarea>
                    <button onclick="addMemo()" class="mt-2 w-full bg-amber-500 text-white py-3 rounded-xl text-sm font-bold shadow-md active:scale-95 transition-transform">
                        メモを残す
                    </button>
                </div>
                <div id="memo-grid" class="flex flex-col gap-3"></div>
            </section>

            <!-- Schedule Section -->
            <section id="content-schedule" class="hidden space-y-4">
                <div class="card-warm p-4 rounded-2xl shadow-sm">
                    <h2 class="font-bold mb-3 flex items-center gap-2 text-gray-700 text-sm">
                        <i data-lucide="calendar-plus" class="w-4 h-4 text-rose-400"></i>
                        予定を追加
                    </h2>
                    <div class="flex flex-col gap-3">
                        <div>
                            <label class="text-[10px] text-amber-800/60 font-bold ml-1">日付</label>
                            <input type="date" id="event-date" class="w-full border border-orange-100 rounded-xl px-4 py-3 text-sm focus:outline-none">
                        </div>
                        <div class="flex gap-2 items-end">
                            <div class="flex-1">
                                <label class="text-[10px] text-amber-800/60 font-bold ml-1">開始</label>
                                <input type="time" id="event-start" step="600" class="w-full border border-orange-100 rounded-xl px-3 py-3 text-sm focus:outline-none">
                            </div>
                            <div class="mb-3 text-amber-800/40 font-bold">〜</div>
                            <div class="flex-1">
                                <label class="text-[10px] text-amber-800/60 font-bold ml-1">終了</label>
                                <input type="time" id="event-end" step="600" class="w-full border border-orange-100 rounded-xl px-3 py-3 text-sm focus:outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-amber-800/60 font-bold ml-1">内容</label>
                            <input type="text" id="event-title" placeholder="内容 (例: 歯医者)" class="w-full border border-orange-100 rounded-xl px-4 py-3 text-sm focus:outline-none">
                        </div>
                        <button onclick="addEvent()" class="mt-1 bg-rose-400 text-white py-3 rounded-xl text-sm font-bold shadow-md active:scale-95 transition-transform">
                            予定を追加
                        </button>
                    </div>
                </div>
                <div class="card-warm rounded-2xl shadow-sm overflow-hidden">
                    <div id="schedule-list" class="divide-y divide-orange-50"></div>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-white/95 backdrop-blur-md border-t border-gray-100 flex justify-around items-center py-2 px-2 z-30">
            <button onclick="switchTab('stock')" id="tab-stock" class="flex-1 py-1 flex flex-col items-center gap-1 transition-colors tab-active">
                <i data-lucide="refrigerator" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">在庫</span>
            </button>
            <button onclick="switchTab('memo')" id="tab-memo" class="flex-1 py-1 flex flex-col items-center gap-1 transition-colors text-gray-400">
                <i data-lucide="sticky-note" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">メモ</span>
            </button>
            <button onclick="switchTab('schedule')" id="tab-schedule" class="flex-1 py-1 flex flex-col items-center gap-1 transition-colors text-gray-400">
                <i data-lucide="calendar" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">予定</span>
            </button>
        </nav>
    </div>

    <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-gray-800/90 text-white px-6 py-2 rounded-full text-xs opacity-0 transition-opacity duration-300 pointer-events-none z-50 shadow-lg"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase Configuration ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-family-dash';

        // --- App State ---
        let appData = {
            stocks: [],
            memos: [],
            events: []
        };
        let user = null;

        // --- Initialization & Auth ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error:", error);
                updateSyncUI(false);
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                startSync();
            }
        });

        const startSync = () => {
            const familyDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'familyContent', 'main');
            
            onSnapshot(familyDocRef, (snapshot) => {
                if (snapshot.exists()) {
                    appData = snapshot.data();
                    renderAll();
                    updateSyncUI(true);
                } else {
                    // Initialize with empty data if doc doesn't exist
                    saveToCloud();
                }
            }, (error) => {
                console.error("Sync error:", error);
                updateSyncUI(false);
            });
        };

        const saveToCloud = async () => {
            if (!user) return;
            const familyDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'familyContent', 'main');
            try {
                await setDoc(familyDocRef, appData);
            } catch (error) {
                console.error("Save error:", error);
                showToast("保存に失敗しました");
            }
        };

        const updateSyncUI = (isOnline) => {
            const indicator = document.getElementById('sync-status');
            const text = document.getElementById('sync-text');
            if (isOnline) {
                indicator.className = "sync-indicator bg-green-500";
                text.innerText = "Family Online";
                text.className = "text-[9px] text-green-600 font-bold uppercase tracking-wider";
            } else {
                indicator.className = "sync-indicator bg-red-500";
                text.innerText = "Offline";
                text.className = "text-[9px] text-red-600 font-bold uppercase tracking-wider";
            }
        };

        // --- Tab & Time UI ---
        const updateTime = () => {
            const now = new Date();
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            document.getElementById('current-time').innerText = 
                `${now.getMonth() + 1}/${now.getDate()}(${days[now.getDay()]}) ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
        };

        window.switchTab = (tab) => {
            ['stock', 'memo', 'schedule'].forEach(s => {
                document.getElementById(`content-${s}`).classList.add('hidden');
                document.getElementById(`tab-${s}`).classList.remove('tab-active');
                document.getElementById(`tab-${s}`).classList.add('text-gray-400');
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('text-gray-400');
            lucide.createIcons();
        };

        const showToast = (message) => {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 2000);
        };

        // --- Stock Logic ---
        window.addStock = () => {
            const input = document.getElementById('stock-name');
            const name = input.value.trim();
            if (!name) return;
            appData.stocks.push({ id: Date.now(), name, needed: false });
            input.value = '';
            saveToCloud();
            showToast('追加しました');
        };

        window.toggleStockStatus = (id) => {
            const item = appData.stocks.find(s => s.id === id);
            if (item) {
                item.needed = !item.needed;
                saveToCloud();
            }
        };

        window.removeStock = (id) => {
            appData.stocks = appData.stocks.filter(s => s.id !== id);
            saveToCloud();
        };

        const renderStocks = () => {
            const list = document.getElementById('stock-list');
            list.innerHTML = '';
            appData.stocks.forEach(item => {
                const card = document.createElement('div');
                card.className = `card-warm rounded-xl shadow-sm stock-card ${item.needed ? 'bg-orange-50 border-orange-300' : ''}`;
                const btnClass = item.needed ? 'bg-orange-500 text-white' : 'bg-emerald-100 text-emerald-700';
                const btnIcon = item.needed ? 'shopping-cart' : 'check';

                card.innerHTML = `
                    <button onclick="removeStock(${item.id})" class="absolute top-1 left-1 text-gray-300 p-1"><i data-lucide="x" class="w-3 h-3"></i></button>
                    <div class="text-center px-1 mb-2">
                        <h3 class="font-bold text-[11px] leading-tight ${item.needed ? 'text-orange-800' : 'text-gray-700'} line-clamp-2">${item.name}</h3>
                    </div>
                    <button onclick="toggleStockStatus(${item.id})" class="status-circle-btn ${btnClass} active:scale-90">
                        <i data-lucide="${btnIcon}" class="w-5 h-5"></i>
                    </button>
                `;
                list.appendChild(card);
            });
            lucide.createIcons();
        };

        // --- Memo Logic ---
        window.addMemo = () => {
            const input = document.getElementById('memo-text');
            const text = input.value.trim();
            if (!text) return;
            appData.memos.unshift({ id: Date.now(), text, date: new Date().toLocaleDateString('ja-JP'), read: false });
            input.value = '';
            saveToCloud();
            showToast('保存しました');
        };

        window.toggleRead = (id) => {
            const memo = appData.memos.find(m => m.id === id);
            if (memo) { memo.read = !memo.read; saveToCloud(); }
        };

        window.deleteMemo = (id) => {
            appData.memos = appData.memos.filter(m => m.id !== id);
            saveToCloud();
        };

        const renderMemos = () => {
            const grid = document.getElementById('memo-grid');
            grid.innerHTML = '';
            appData.memos.forEach(memo => {
                const note = document.createElement('div');
                note.className = `sticky-note p-4 rounded-xl relative ${memo.read ? 'read' : ''}`;
                const readBtn = memo.read 
                    ? `<span class="flex items-center gap-1 text-emerald-600 font-bold text-[10px]"><i data-lucide="check-circle-2" class="w-3.5 h-3.5"></i>既読</span>`
                    : `<button onclick="toggleRead(${memo.id})" class="bg-white/80 text-amber-800 px-3 py-1.5 rounded-lg text-[10px] font-bold border border-amber-200">既読にする</button>`;
                
                note.innerHTML = `
                    <p class="text-sm text-gray-800 leading-relaxed break-words whitespace-pre-wrap">${memo.text}</p>
                    <div class="mt-4 flex justify-between items-end border-t border-amber-800/5 pt-3">
                        <div class="flex items-center gap-3">
                            <span class="text-[9px] text-amber-800/40 font-bold">${memo.date}</span>
                            ${readBtn}
                        </div>
                        <button onclick="deleteMemo(${memo.id})" class="text-gray-300 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                `;
                grid.appendChild(note);
            });
            lucide.createIcons();
        };

        // --- Schedule Logic ---
        window.addEvent = () => {
            const date = document.getElementById('event-date').value;
            const startTime = document.getElementById('event-start').value;
            const endTime = document.getElementById('event-end').value;
            const title = document.getElementById('event-title').value;
            if (!date || !title) return;

            appData.events.push({ id: Date.now(), date, startTime, endTime, title });
            appData.events.sort((a, b) => {
                const dateCompare = new Date(a.date) - new Date(b.date);
                if (dateCompare !== 0) return dateCompare;
                return (a.startTime || "00:00").localeCompare(b.startTime || "00:00");
            });

            document.getElementById('event-date').value = '';
            document.getElementById('event-start').value = '';
            document.getElementById('event-end').value = '';
            document.getElementById('event-title').value = '';
            saveToCloud();
            showToast('追加しました');
        };

        window.deleteEvent = (id) => {
            appData.events = appData.events.filter(e => e.id !== id);
            saveToCloud();
        };

        const renderEvents = () => {
            const list = document.getElementById('schedule-list');
            list.innerHTML = '';
            if (appData.events.length === 0) {
                list.innerHTML = `<div class="p-8 text-center text-amber-800/30 text-xs">予定はありません</div>`;
                return;
            }
            appData.events.forEach(event => {
                const timeDisplay = event.startTime 
                    ? `<span class="text-[11px] font-bold text-rose-500 bg-rose-50 px-2 py-0.5 rounded-full">${event.startTime}${event.endTime ? ' 〜 ' + event.endTime : ''}</span>`
                    : '';
                const item = document.createElement('div');
                item.className = "flex items-center justify-between p-4";
                item.innerHTML = `
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-bold text-gray-400">${event.date.replace(/-/g, '/')}</span>
                            ${timeDisplay}
                        </div>
                        <span class="text-sm font-medium text-gray-700">${event.title}</span>
                    </div>
                    <button onclick="deleteEvent(${event.id})" class="text-gray-300 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        };

        const renderAll = () => {
            renderStocks();
            renderMemos();
            renderEvents();
        };

        // Start everything
        initAuth();
        updateTime();
        setInterval(updateTime, 1000);

    </script>
</body>
</html>

